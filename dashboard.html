<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - AR ë³´í–‰ ì¸¡ì •</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --secondary: #6366F1;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-dark: #0F172A;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-glass: rgba(255, 255, 255, 0.08);
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: linear-gradient(160deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
            color: var(--text-primary);
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 36px;
            height: auto;
            border-radius: 8px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .user-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .btn-logout {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Main Content */
        .main {
            padding: 84px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--bg-glass);
            padding: 6px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--bg-card);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #4F46E5);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #DC2626);
            color: white;
        }

        .btn-outline {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Patient List */
        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .patient-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .patient-item:hover {
            border-color: var(--primary);
        }

        .patient-info {
            flex: 1;
        }

        .patient-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .patient-details {
            font-size: 13px;
            color: var(--text-muted);
        }

        .patient-actions {
            display: flex;
            gap: 8px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-dark);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 480px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Measurement History */
        .measurement-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .measurement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .measurement-time {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .measurement-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .measurement-type {
            padding: 4px 10px;
            background: var(--secondary);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header {
                padding: 0 16px;
            }

            .main {
                padding: 76px 16px 16px;
            }

            .patient-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .patient-actions {
                width: 100%;
            }

            .patient-actions .btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <img src="logo.jpeg" alt="THYM" class="header-logo">
            <span class="header-title">AR ë³´í–‰ ì¸¡ì •</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span class="user-name" id="userName">ë¡œë”© ì¤‘...</span>
            </div>
            <button class="btn-logout" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="patientCount">0</div>
                <div class="stat-label">ë“±ë¡ í™˜ì</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="measurementCount">0</div>
                <div class="stat-label">ì´ ì¸¡ì •</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayCount">0</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì¸¡ì •</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="patients">í™˜ì ëª©ë¡</button>
            <button class="tab" data-tab="measurements">ì¸¡ì • ê¸°ë¡</button>
        </div>

        <!-- Patients Tab -->
        <div id="patientsTab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ë‚´ í™˜ì ëª©ë¡</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-outline" id="exportPatientsBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-primary" id="addPatientBtn">+ í™˜ì ì¶”ê°€</button>
                    </div>
                </div>
                <div id="patientList" class="patient-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>í™˜ì ëª©ë¡ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Measurements Tab -->
        <div id="measurementsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ì¸¡ì • ê¸°ë¡</h2>
                    <button class="btn btn-outline" id="exportMeasurementsBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
                </div>
                <div id="measurementList" class="measurement-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ì¸¡ì • ê¸°ë¡ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Patient Modal -->
    <div class="modal-overlay" id="patientModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">í™˜ì ì¶”ê°€</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="patientForm">
                <input type="hidden" id="patientId">
                <div class="form-group">
                    <label for="patientName">ì´ë¦„ *</label>
                    <input type="text" id="patientName" placeholder="í™˜ì ì´ë¦„" required>
                </div>
                <div class="form-group">
                    <label for="patientBirth">ìƒë…„ì›”ì¼</label>
                    <input type="date" id="patientBirth">
                </div>
                <div class="form-group">
                    <label for="patientPhone">ì—°ë½ì²˜</label>
                    <input type="tel" id="patientPhone" placeholder="010-0000-0000">
                </div>
                <div class="form-group">
                    <label for="patientMemo">ë©”ëª¨</label>
                    <textarea id="patientMemo" placeholder="íŠ¹ì´ì‚¬í•­, ì§„ë‹¨ëª… ë“±"></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-outline" style="flex: 1;" id="cancelBtn">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Detail Modal -->
    <div class="modal-overlay" id="patientDetailModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="detailPatientName">í™˜ì ìƒì„¸</h3>
                <button class="modal-close" id="closeDetailModal">&times;</button>
            </div>
            <div id="patientDetailContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" style="flex: 1;" id="startMeasureBtn">ì¸¡ì • ì‹œì‘</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        let currentUser = null;
        let patientsList = [];
        let measurementsList = [];

        // DOM Elements
        const userNameEl = document.getElementById('userName');
        const patientCountEl = document.getElementById('patientCount');
        const measurementCountEl = document.getElementById('measurementCount');
        const todayCountEl = document.getElementById('todayCount');
        const patientListEl = document.getElementById('patientList');
        const measurementListEl = document.getElementById('measurementList');
        const patientModal = document.getElementById('patientModal');
        const patientDetailModal = document.getElementById('patientDetailModal');
        const patientForm = document.getElementById('patientForm');

        // Check authentication
        async function checkAuth() {
            currentUser = await auth.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Redirect admin to admin page
            if (currentUser.profile?.role === 'admin') {
                window.location.href = 'admin.html';
                return;
            }

            userNameEl.textContent = currentUser.profile?.name || currentUser.email;
            loadData();
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadPatients(),
                loadMeasurements()
            ]);
            updateStats();
        }

        // Load patients
        async function loadPatients() {
            try {
                patientsList = await patients.getMyPatients();
                renderPatients();
            } catch (error) {
                console.error('Error loading patients:', error);
                patientListEl.innerHTML = '<div class="empty-state"><p>í™˜ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        // Load measurements
        async function loadMeasurements() {
            try {
                measurementsList = await measurements.getMyMeasurements();
                renderMeasurements();
            } catch (error) {
                console.error('Error loading measurements:', error);
            }
        }

        // Render patients list
        function renderPatients() {
            if (patientsList.length === 0) {
                patientListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¤</div>
                        <p>ë“±ë¡ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 13px; margin-top: 8px;">í™˜ìë¥¼ ì¶”ê°€í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            patientListEl.innerHTML = patientsList.map(patient => `
                <div class="patient-item" data-id="${patient.id}">
                    <div class="patient-info">
                        <div class="patient-name">${patient.name}</div>
                        <div class="patient-details">
                            ${patient.birth_date ? formatDate(patient.birth_date) + ' | ' : ''}
                            ${patient.phone || 'ì—°ë½ì²˜ ì—†ìŒ'}
                        </div>
                    </div>
                    <div class="patient-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewPatient('${patient.id}')">ìƒì„¸</button>
                        <button class="btn btn-sm btn-outline" onclick="editPatient('${patient.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePatient('${patient.id}')">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        // Render measurements list
        function renderMeasurements() {
            if (measurementsList.length === 0) {
                measurementListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>ì¸¡ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            measurementListEl.innerHTML = measurementsList.map(m => `
                <div class="measurement-item">
                    <div>
                        <div class="measurement-time">${m.time_formatted}</div>
                        <div class="measurement-meta">${m.patients?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'} | ${formatDateTime(m.created_at)}</div>
                    </div>
                    <span class="measurement-type">${m.test_type}</span>
                </div>
            `).join('');
        }

        // Update stats
        function updateStats() {
            patientCountEl.textContent = patientsList.length;
            measurementCountEl.textContent = measurementsList.length;

            // Count today's measurements
            const today = new Date().toDateString();
            const todayMeasurements = measurementsList.filter(m =>
                new Date(m.created_at).toDateString() === today
            );
            todayCountEl.textContent = todayMeasurements.length;
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR');
        }

        // Format datetime
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Open add patient modal
        function openAddPatientModal() {
            document.getElementById('modalTitle').textContent = 'í™˜ì ì¶”ê°€';
            document.getElementById('patientId').value = '';
            patientForm.reset();
            patientModal.classList.add('active');
        }

        // Edit patient
        function editPatient(id) {
            const patient = patientsList.find(p => p.id === id);
            if (!patient) return;

            document.getElementById('modalTitle').textContent = 'í™˜ì ìˆ˜ì •';
            document.getElementById('patientId').value = patient.id;
            document.getElementById('patientName').value = patient.name || '';
            document.getElementById('patientBirth').value = patient.birth_date || '';
            document.getElementById('patientPhone').value = patient.phone || '';
            document.getElementById('patientMemo').value = patient.memo || '';
            patientModal.classList.add('active');
        }

        // View patient detail
        async function viewPatient(id) {
            const patient = patientsList.find(p => p.id === id);
            if (!patient) return;

            document.getElementById('detailPatientName').textContent = patient.name;

            // Load patient measurements
            const patientMeasurements = await measurements.getPatientMeasurements(id);

            let content = `
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--text-muted); font-size: 13px;">ìƒë…„ì›”ì¼</p>
                    <p>${patient.birth_date ? formatDate(patient.birth_date) : '-'}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--text-muted); font-size: 13px;">ì—°ë½ì²˜</p>
                    <p>${patient.phone || '-'}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--text-muted); font-size: 13px;">ë©”ëª¨</p>
                    <p>${patient.memo || '-'}</p>
                </div>
                <div>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">ì¸¡ì • ê¸°ë¡ (${patientMeasurements.length}íšŒ)</p>
            `;

            if (patientMeasurements.length > 0) {
                content += '<div class="measurement-list" style="max-height: 200px;">';
                content += patientMeasurements.map(m => `
                    <div class="measurement-item">
                        <div>
                            <div class="measurement-time">${m.time_formatted}</div>
                            <div class="measurement-meta">${formatDateTime(m.created_at)}</div>
                        </div>
                        <span class="measurement-type">${m.test_type}</span>
                    </div>
                `).join('');
                content += '</div>';
            } else {
                content += '<p style="color: var(--text-muted);">ì¸¡ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            content += '</div>';

            document.getElementById('patientDetailContent').innerHTML = content;
            document.getElementById('startMeasureBtn').onclick = () => {
                // Store selected patient and go to measurement page
                sessionStorage.setItem('selectedPatient', JSON.stringify(patient));
                window.location.href = 'index.html';
            };

            patientDetailModal.classList.add('active');
        }

        // Delete patient
        async function deletePatient(id) {
            const patient = patientsList.find(p => p.id === id);
            if (!patient) return;

            if (!confirm(`"${patient.name}" í™˜ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ëœ ì¸¡ì • ê¸°ë¡ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                await patients.deletePatient(id);
                await loadData();
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // Save patient
        async function savePatient(e) {
            e.preventDefault();

            const id = document.getElementById('patientId').value;
            const data = {
                name: document.getElementById('patientName').value.trim(),
                birth_date: document.getElementById('patientBirth').value || null,
                phone: document.getElementById('patientPhone').value.trim() || null,
                memo: document.getElementById('patientMemo').value.trim() || null
            };

            if (!data.name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                if (id) {
                    await patients.updatePatient(id, data);
                } else {
                    await patients.addPatient(data);
                }
                patientModal.classList.remove('active');
                await loadData();
            } catch (error) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
            });
        });

        // Event listeners
        document.getElementById('addPatientBtn').addEventListener('click', openAddPatientModal);
        document.getElementById('closeModal').addEventListener('click', () => patientModal.classList.remove('active'));
        document.getElementById('cancelBtn').addEventListener('click', () => patientModal.classList.remove('active'));
        document.getElementById('closeDetailModal').addEventListener('click', () => patientDetailModal.classList.remove('active'));
        patientForm.addEventListener('submit', savePatient);

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await auth.signOut();
            window.location.href = 'login.html';
        });

        // Export buttons
        document.getElementById('exportPatientsBtn').addEventListener('click', () => {
            const exportData = patientsList.map(p => ({
                ì´ë¦„: p.name,
                ìƒë…„ì›”ì¼: p.birth_date || '',
                ì—°ë½ì²˜: p.phone || '',
                ë©”ëª¨: p.memo || '',
                ë“±ë¡ì¼: formatDateTime(p.created_at)
            }));
            exportToExcel(exportData, 'patients');
        });

        document.getElementById('exportMeasurementsBtn').addEventListener('click', () => {
            const exportData = measurementsList.map(m => ({
                í™˜ì: m.patients?.name || '',
                í…ŒìŠ¤íŠ¸: m.test_type,
                ì‹œê°„_ms: m.time_ms,
                ì‹œê°„: m.time_formatted,
                ì¸¡ì •ì¼: formatDateTime(m.created_at)
            }));
            exportToExcel(exportData, 'measurements');
        });

        // Close modals on overlay click
        patientModal.addEventListener('click', (e) => {
            if (e.target === patientModal) patientModal.classList.remove('active');
        });
        patientDetailModal.addEventListener('click', (e) => {
            if (e.target === patientDetailModal) patientDetailModal.classList.remove('active');
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>
